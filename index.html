<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Menopause Q&A</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow-x: hidden; /* Prevent horizontal scrollbar */
    overflow-y: hidden; /* Prevent vertical scrollbar inside iframe */
    font-family: 'Poppins', sans-serif;
    background: #ffe9e5;
    color: #000;
    width: 100%;
    box-sizing: border-box;
  }
  *, *::before, *::after {
    box-sizing: border-box;
  }
  #QandAHeader {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 20px;
    max-width: 520px; /* Controls width of search + button */
    width: 100%;
  }
  #Q\&AContainer {
    padding: 20px;
    width: 100%;
    box-sizing: border-box;
  }
  #searchInput {
    flex: 1;
    font-size: 1rem;
    padding: 10px 14px;
    border-radius: 6px;
    border: 1px solid #ffd2cb;
    font-family: 'Poppins', sans-serif;
    font-weight: 400;
  }
  #clearSearch {
    background: #cccccc;
    border: none;
    color: #666666;
    padding: 10px 14px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease, color 0.3s ease;
    font-family: 'Poppins', sans-serif;
    flex-shrink: 0;
  }
  #clearSearch.active {
    background: #ffa798;
    color: white;
  }
  #clearSearch.active:hover {
    background: #ff8c7a;
  }
  #clearSearch:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }
  #categoriesContainer {
    margin-bottom: 25px;
  }
  .category-btn {
    background: white;
    border: 1px solid #ffd2cb;
    border-radius: 6px;
    padding: 8px 16px;
    margin: 4px 8px 4px 0;
    cursor: pointer;
    font-weight: 600;
    font-family: 'Poppins', sans-serif;
    transition: background-color 0.3s ease;
    color: black;
    text-decoration: none;
  }
  .category-btn.active,
  .category-btn:hover {
    background-color: #ffa798;
    color: white;
    border-color: #ffa798;
  }
  .qa-item {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .qa-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  .question {
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 10px;
    cursor: pointer;
  }
  .question:hover {
    color: #ffa798;
  }
  .answer {
    font-weight: 400;
    font-size: 1rem;
    line-height: 1.4;
    white-space: pre-wrap;
    display: none; /* Hidden by default */
    margin-top: 10px;
  }
  
  /* Enhanced link styling that overrides system defaults */
  .answer a,
  .answer a:link,
  .answer a:visited,
  .answer a:active {
    color: #8e599c !important;
    text-decoration: underline !important;
    transition: color 0.3s ease !important;
    -webkit-tap-highlight-color: rgba(142, 89, 156, 0.3) !important;
  }
  
  .answer a:hover,
  .answer a:focus {
    color: #7a4d87 !important;
    text-decoration: underline !important;
  }
  
  /* Additional mobile-specific overrides */
  @media (max-width: 768px) {
    .answer a,
    .answer a:link,
    .answer a:visited,
    .answer a:active {
      color: #8e599c !important;
      -webkit-touch-callout: default !important;
      -webkit-user-select: auto !important;
    }
  }
  
  /* iOS Safari specific overrides */
  @supports (-webkit-overflow-scrolling: touch) {
    .answer a,
    .answer a:link,
    .answer a:visited,
    .answer a:active {
      color: #8e599c !important;
    }
  }
  
  .qa-item.open .answer {
    display: block;
  }
  @media (max-width: 600px) {
    #Q\&AContainer {
      padding: 15px;
    }
    #QandAHeader {
      flex-direction: column;
      max-width: 100%;
      gap: 8px;
    }
    #searchInput {
      width: 100%;
      min-width: 0;
    }
    #clearSearch {
      width: 100%;
      padding: 12px 14px;
    }
    .category-btn {
      padding: 6px 12px;
      margin: 3px 6px 3px 0;
      font-size: 0.9rem;
    }
  }
</style>
</head>
<body>
<div id="Q&AContainer">
<div id="QandAHeader">
  <input type="text" id="searchInput" placeholder="Search questions, categories, or tags..." aria-label="Search questions" />
  <button id="clearSearch">Clear Search</button>
</div>

<div id="categoriesContainer" aria-label="Category filters"></div>

<div id="qaContainer" role="main" aria-live="polite"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
  const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTO1U9U8o-4nOTkHG8X76aZa2OeOyJHdl0ENDM0dASstn9hStwSFLwbKwlswDG-hWe_ildJ8zVy2eja/pub?gid=0&single=true&output=csv';

  let allData = [];
  let filteredData = [];
  let categories = new Set();
  let activeCategory = 'All';
  let currentlyOpenItem = null; // Track the currently open item

  const searchInput = document.getElementById('searchInput');
  const clearSearchBtn = document.getElementById('clearSearch');
  const categoriesContainer = document.getElementById('categoriesContainer');
  const qaContainer = document.getElementById('qaContainer');

  // Function to update clear button state
  function updateClearButtonState() {
    const hasSearchTerm = searchInput.value.trim().length > 0;
    if (hasSearchTerm) {
      clearSearchBtn.classList.add('active');
      clearSearchBtn.disabled = false;
    } else {
      clearSearchBtn.classList.remove('active');
      clearSearchBtn.disabled = true;
    }
  }

  function createCategoryButtons() {
    categoriesContainer.innerHTML = '';

    // Add "All" button first
    const allBtn = document.createElement('button');
    allBtn.textContent = 'All';
    allBtn.className = 'category-btn active';
    allBtn.addEventListener('click', () => {
      activeCategory = 'All';
      updateActiveCategoryButtons();
      filterAndRender();
    });
    categoriesContainer.appendChild(allBtn);

    Array.from(categories).sort().forEach(cat => {
      const btn = document.createElement('button');
      btn.textContent = cat;
      btn.className = 'category-btn';
      btn.addEventListener('click', () => {
        activeCategory = cat;
        updateActiveCategoryButtons();
        filterAndRender();
      });
      categoriesContainer.appendChild(btn);
    });
  }

  function updateActiveCategoryButtons() {
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.classList.toggle('active', btn.textContent === activeCategory);
    });
  }

  function filterAndRender() {
    const searchTerm = searchInput.value.trim().toLowerCase();
    updateClearButtonState(); // Update button state when filtering

    filteredData = allData.filter(item => {
      const inCategory = (activeCategory === 'All' || item.Category === activeCategory);
      const searchableText = (item.Category + ' ' + item.Question + ' ' + item.Tags).toLowerCase();
      const matchesSearch = searchableText.includes(searchTerm);

      return inCategory && matchesSearch;
    });

    // Reset currently open item when filtering
    currentlyOpenItem = null;
    renderQAItems();
  }

  // Function to process HTML content and ensure proper formatting
  function processHTMLContent(content) {
    if (!content) return '';
    
    // Basic safety: sanitize any potentially dangerous scripts while preserving formatting
    let processed = content
      .replace(/<script[^>]*>.*?<\/script>/gi, '')
      .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '')
      .replace(/on\w+\s*=\s*["'][^"']*["']/gi, ''); // Remove event handlers
    
    // Make all links open in new windows with security attributes
    processed = processed.replace(/<a\s+([^>]*?)>/gi, (match, attributes) => {
      // Check if target is already specified
      if (!/target\s*=/i.test(attributes)) {
        attributes += ' target="_blank"';
      }
      // Check if rel is already specified, if not add security attributes
      if (!/rel\s*=/i.test(attributes)) {
        attributes += ' rel="noopener noreferrer"';
      } else {
        // If rel exists, ensure it includes noopener noreferrer
        attributes = attributes.replace(/rel\s*=\s*["']([^"']*)["']/i, (relMatch, relValue) => {
          if (!relValue.includes('noopener')) relValue += ' noopener';
          if (!relValue.includes('noreferrer')) relValue += ' noreferrer';
          return `rel="${relValue.trim()}"`;
        });
      }
      return `<a ${attributes.trim()}>`;
    });
    
    return processed;
  }

  function renderQAItems() {
    qaContainer.innerHTML = '';

    if (filteredData.length === 0) {
      qaContainer.innerHTML = '<p>No results found.</p>';
      sendIframeHeight();
      return;
    }

    filteredData.forEach(item => {
      const itemDiv = document.createElement('div');
      itemDiv.className = 'qa-item';

      const question = document.createElement('div');
      question.className = 'question';
      question.textContent = item.Question;

      const answer = document.createElement('div');
      answer.className = 'answer';
      // Use innerHTML to render HTML formatting, but process it for safety
      answer.innerHTML = processHTMLContent(item.Answer);

      itemDiv.appendChild(question);
      itemDiv.appendChild(answer);

      itemDiv.addEventListener('click', () => {
        // If clicking on the currently open item, close it
        if (currentlyOpenItem === itemDiv) {
          itemDiv.classList.remove('open');
          currentlyOpenItem = null;
        } else {
          // Close the previously open item if it exists
          if (currentlyOpenItem) {
            currentlyOpenItem.classList.remove('open');
          }
          // Open the clicked item
          itemDiv.classList.add('open');
          currentlyOpenItem = itemDiv;
        }
        sendIframeHeight();
      });

      qaContainer.appendChild(itemDiv);
    });

    sendIframeHeight();
  }

  // Debounce helper
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  function loadData() {
    Papa.parse(csvUrl, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        allData = results.data.map(row => ({
          Category: row['Category']?.trim() || '',
          Question: row['Question']?.trim() || '',
          Answer: row['Answer']?.trim() || '',
          Tags: row['Tags']?.trim() || '',
        }));

        categories = new Set(allData.map(item => item.Category).filter(c => c));

        createCategoryButtons();
        updateClearButtonState(); // Initialize button state
        filterAndRender();
      },
      error: function(err) {
        qaContainer.innerHTML = '<p>Error loading data.</p>';
        console.error('CSV load error:', err);
      }
    });
  }

  searchInput.addEventListener('input', debounce(filterAndRender, 250));
  clearSearchBtn.addEventListener('click', () => {
    searchInput.value = '';
    updateClearButtonState();
    filterAndRender();
  });

  loadData();
</script>
</div>
<script>
    function sendIframeHeight() {
        const contentContainer = document.getElementById('Q&AContainer');
        if (contentContainer) {
            const height = contentContainer.scrollHeight + 50; // extra buffer to avoid scrollbar
            window.parent.postMessage({ type: 'setIframeHeight', height: height }, 'https://www.menohello.com');
        }
    }
    window.addEventListener('DOMContentLoaded', sendIframeHeight);
    window.addEventListener('load', sendIframeHeight);
    const containerToObserve = document.getElementById('Q&AContainer'); 
    if (containerToObserve) {
        const resizeObserver = new ResizeObserver(sendIframeHeight);
        resizeObserver.observe(containerToObserve);
    }
</script>
</body>
</html>
